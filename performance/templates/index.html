<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Performance Predictor</title>
    <link rel="stylesheet" href="{% static 'performance/index.css' %}" />
</head>
<body>
<div class="shell">
    <header class="topbar">
        <div class="brand">
            <div class="brand-dot" aria-hidden="true"></div>
            <div>
                <p class="brand-kicker">Student ML</p>
                <h1 class="brand-title">Student Performance Predictor</h1>
            </div>
        </div>
        <div class="topbar-meta">
            <span class="meta-chip">API: <code>/api/predict/</code></span>
            <span class="meta-chip">Model: <code>performance/model.pkl</code></span>
        </div>
    </header>

    <main class="grid">
        <section class="panel result-panel" aria-live="polite">
            <div class="panel-head">
                <h2>Result</h2>
                <p class="muted">Prediction updates after you submit the form.</p>
            </div>

            <div class="score-wrap">
                <div class="score-value" id="score-value">– –</div>
                <div class="score-unit">/ 100</div>
            </div>

            <div class="category-row" id="category-row" hidden>
                <span class="category-pill" id="category-pill">Category</span>
                <span class="category-sub" id="category-sub"></span>
            </div>

            <div class="status-row">
                <p id="status" class="status">Ready. Fill in the fields and click predict.</p>
            </div>

            <div class="rules">
                <p class="rules-title">Smart validation rules</p>
                <ul>
                    <li>Sleep: 4–12 hours/night</li>
                    <li>Study: 0–12 hours/day</li>
                    <li>Sleep + study must be ≤ 18 hours/day</li>
                </ul>
            </div>
        </section>

        <section class="panel form-panel">
            <div class="panel-head">
                <h2>Inputs</h2>
                <p class="muted">Use realistic daily averages for best results.</p>
            </div>

            <form id="prediction-form">
                <div class="field-grid">
                    <div class="field">
                        <label for="hours_studied">Hours studied per day <span>*</span></label>
                        <input
                            id="hours_studied"
                            name="hours_studied"
                            type="number"
                            min="0"
                            max="16"
                            step="0.1"
                            placeholder="e.g. 3.5"
                            required
                        />
                        <p class="hint">0–16 hours/day (use a realistic average).</p>
                    </div>

                    <div class="field">
                        <label for="sleep_hours">Sleep hours per night <span>*</span></label>
                        <input
                            id="sleep_hours"
                            name="sleep_hours"
                            type="number"
                            min="0"
                            max="14"
                            step="0.1"
                            placeholder="e.g. 7.5"
                            required
                        />
                        <p class="hint">0–14 hours/night (use a realistic average).</p>
                    </div>

                    <div class="field">
                        <label for="previous_scores">Previous exam score (0‑100) <span>*</span></label>
                        <input
                            id="previous_scores"
                            name="previous_scores"
                            type="number"
                            min="0"
                            max="100"
                            step="0.1"
                            placeholder="e.g. 78"
                            required
                        />
                        <p class="hint">0–100.</p>
                    </div>

                    <div class="field">
                        <label for="sample_papers">Sample papers practiced <span>*</span></label>
                        <input
                            id="sample_papers"
                            name="sample_papers"
                            type="number"
                            min="0"
                            max="200"
                            step="1"
                            placeholder="e.g. 5"
                            required
                        />
                        <p class="hint">0–200.</p>
                    </div>
                </div>

                <div class="checkbox-row">
                    <input id="extracurricular" name="extracurricular" type="checkbox" />
                    <label for="extracurricular">Participates in extracurricular activities</label>
                </div>

                <div class="actions">
                    <button class="btn-primary" type="submit">
                        <span class="dot"></span>
                        Run prediction
                    </button>
                </div>
            </form>
        </section>
    </main>
</div>

<script>
    async function predictPerformance(event) {
        event.preventDefault();

        const form = document.getElementById("prediction-form");
        const statusEl = document.getElementById("status");
        const scoreValueEl = document.getElementById("score-value");

        const hours_studied = parseFloat(form.hours_studied.value);
        const previous_scores = parseFloat(form.previous_scores.value);
        const sleep_hours = parseFloat(form.sleep_hours.value);
        const sample_papers = parseInt(form.sample_papers.value, 10);
        const extracurricular = form.extracurricular.checked;

        if (
            Number.isNaN(hours_studied) ||
            Number.isNaN(previous_scores) ||
            Number.isNaN(sleep_hours) ||
            Number.isNaN(sample_papers)
        ) {
            statusEl.textContent = "Please fill in all required numeric fields.";
            statusEl.classList.remove("success");
            statusEl.classList.add("error");
            return;
        }

        const payload = {
            hours_studied,
            previous_scores,
            extracurricular,
            sleep_hours,
            sample_papers,
        };

        statusEl.textContent = "Predicting…";
        statusEl.classList.remove("error", "success");

        try {
            const response = await fetch("/api/predict/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            });

            const data = await response.json();
            const categoryRow = document.getElementById("category-row");
            const categoryPill = document.getElementById("category-pill");
            const categorySub = document.getElementById("category-sub");

            const applyCategory = (d) => {
                if (d && d.category && d.category.label) {
                    categoryRow.hidden = false;
                    categoryPill.textContent = d.category.label;
                    categoryPill.className = "category-pill " + (d.category.category || "");
                    const flags = Array.isArray(d.category.flags) ? d.category.flags : [];
                    categorySub.textContent = flags.length ? ("Flags: " + flags.join(", ")) : "";
                } else {
                    categoryRow.hidden = true;
                }
            };

            if (!response.ok) {
                // If backend provided a forced score/category (e.g. impossible inputs),
                // reflect it in the UI, then show an error message.
                if (d && typeof d.predicted_performance_index === "number") {
                    scoreValueEl.textContent = d.predicted_performance_index.toFixed(2);
                }
                applyCategory(d);

                const msg =
                    (d && d.detail) ||
                    "Request failed with status " + response.status;
                const fieldErrors =
                    d && d.errors
                        ? Object.values(d.errors).filter(Boolean).join(" ")
                        : "";
                throw new Error(fieldErrors ? msg + " " + fieldErrors : msg);
            }

            if (typeof data.predicted_performance_index === "number") {
                scoreValueEl.textContent = data.predicted_performance_index.toFixed(2);
                applyCategory(data);

                statusEl.textContent =
                    data.category && Array.isArray(data.category.tips) && data.category.tips.length
                        ? data.category.tips[0]
                        : "Prediction updated.";
                statusEl.classList.remove("error");
                statusEl.classList.add("success");
            } else {
                throw new Error("Unexpected response format from API.");
            }
        } catch (error) {
            console.error(error);
            statusEl.textContent = error?.message
                ? error.message
                : "Could not fetch prediction. Make sure the Django server is running and /api/predict/ is reachable.";
            statusEl.classList.remove("success");
            statusEl.classList.add("error");
        }
    }

    document
        .getElementById("prediction-form")
        .addEventListener("submit", predictPerformance);
</script>
</body>
</html>

